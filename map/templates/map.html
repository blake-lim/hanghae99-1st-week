<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>키워드로 장소검색하기</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>

<body>
    <!-- 지도가 들어갈 div -->
    <div id="map" style="width: 500px; height: 500px; margin:auto; margin-top: 20px"></div>

    <!-- 지도 표시를 위한 url -->
    <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c303439fed571295dec718c23b86b7f7&libraries=services"></script>
    <script>
        let mapContainer = document.getElementById('map'), // 지도를 표시할 div        
            mapOption = {
                center: new daum.maps.LatLng(33.450701, 126.570667), // 지도의 중심좌표
                level: 5 // 지도의 확대 레벨
            };


        //지도를 미리 생성
        let map = new daum.maps.Map(mapContainer, mapOption);
        
        //장소명을 알려줄 컨텐츠임
        var infowindow = new kakao.maps.InfoWindow({zIndex:1});

        get_item();
        
        function get_item(){
            $.ajax({
                type: "GET",
                url: "/pos",
                data: {},
                success: function (response){
                    //response값 저장
                    let position_info = response['position_info'][0];
                    show_map(position_info);
                }
            });
        }

        function show_map(position_info){
            //좌표 저장
            var coords = new daum.maps.LatLng(position_info['PY'], position_info['PX']);
            var position_name = position_info['PNAME'];

            //지도를 보여준다
            mapContainer.style.display = 'block';
            map.relayout();

            //지도 중심을 변경(좌표가 숫자가 아니라 문자였음 해결됨)
            map.setCenter(coords);

            disp_title(position_name, map, coords);
        }
        
        function disp_title(title, map, coords){
            let marker = new daum.maps.Marker({
                position: coords,
                map: map
            });
            kakao.maps.event.addListener(marker, 'mouseover', function(){
                displayInfowindow(marker, title);
            });
            
            kakao.maps.event.addListener(marker, 'mouseout', function(){
                infowindow.close();
            });
        }

        //텍스트 박스 생성기
        function displayInfowindow(marker, title){
            let lens = title.length * 12.5
            let content = `<div style="width:${lens.toString()}px;text-align:center;padding:6px 0;">`+title+'</div>'
            infowindow.setContent(content);
            infowindow.open(map, marker);
        };
    </script>

</body>
</html>